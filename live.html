<html lang="">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Example of plotting live data with websockets and highcharts</title>

  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
  <script src="assets/paho-mqtt.js" type="text/javascript"></script>
  <script type="text/javascript">
      //settings BEGIN
      const MQTTBroker = 'www.tom.org';
      const MQTTPort = 8083;
      const MQTTSubTopic = 'energy/vt/energy'; //works with wildcard # and + topics dynamically now
      //settings END

      let chart; // global variable for chart
      let dataTopics = [];

      //mqtt broker
      let client = new Paho.MQTT.Client(MQTTBroker, MQTTPort, "/mqtt",
          "myclientid_" + (Math.random() * 100).toString());
      client.onMessageArrived = onMessageArrived;
      client.onConnectionLost = onConnectionLost;

      let options = {
          timeout: 3,
          useSSL: true,
          onSuccess: function () {
              console.log("mqtt connected");
              // Connection succeeded; subscribe to our topics
              client.subscribe(MQTTSubTopic, {qos: 1});
          },
          onFailure: function (message) {
              console.log("Connection failed, ERROR: " + message.errorMessage);
              //window.setTimeout(location.reload(),20000); //wait 20seconds before trying to connect again.
          }
      };

      //can be used to reconnect on connection lost
      function onConnectionLost(responseObject) {
          console.log("connection lost: " + responseObject.errorMessage);
          //window.setTimeout(location.reload(),20000); //wait 20seconds before trying to connect again.
      }

      //what is done when a message arrives from the broker
      function onMessageArrived(message) {
          console.log(message.destinationName, '', message.payloadString);
          const energyData = JSON.parse(message.payloadString);
          //check if it is a new topic, if not add it to the array
          if (dataTopics.indexOf(message.destinationName) < 0) {
              dataTopics.push(message.destinationName); //add new topic to array
              let y = dataTopics.indexOf(message.destinationName); //get the index no
              //create new data series for the chart
              let newSeries = {
                  id: y,
                  name: message.destinationName,
                  data: {{ .LoadData }}
              };
              chart.addSeries(newSeries); //add the series
          }
          let y = dataTopics.indexOf(message.destinationName); //get the index no of the topic from the array
          let myEpoch = new Date().getTime(); //get current epoch time
          let load = Math.round(energyData.load.instant_power);
          let plotLoad = [myEpoch, Number(load)]; //create the array
          if (isNumber(load)) { //check if it is a real number and not text
              console.log('is a proper number, will send to chart.')
              plot(plotLoad, y);	//send it to the plot function
          }
      }

      //check if a real number
      function isNumber(n) {
          return !isNaN(parseFloat(n)) && isFinite(n);
      }

      //function that is called once the document has loaded
      function init() {
          Highcharts.setOptions({
              lang: {
                  thousandsSep: ','
              },
              global: {
                  useUTC: false
              }
          });
          // Connect to MQTT broker
          client.connect(options);
      }

      //this adds the plots to the chart
      function plot(point, chartNo) {
          console.log(point);

          let series = chart.series[0],
              shift = series.data.length > 2000; // shift if the series is
          // longer than 20
          // add the point
          chart.series[chartNo].addPoint(point, true, shift);

      }
      //settings for the chart
      $(document).ready(function () {
          chart = new Highcharts.Chart({
              chart: {
                  renderTo: 'container',
                  defaultSeriesType: 'spline'
              },
              title: {
                  text: 'Plotting Live websockets data from a MQTT topic'
              },
              subtitle: {
                  text: 'broker: ' + MQTTBroker + ' | port: ' + MQTTPort + ' | topic : ' + MQTTSubTopic
              },
              xAxis: {
                  type: 'datetime',
                  tickPixelInterval: 150,
                  maxZoom: 20 * 1000
              },
              yAxis: {
                  minPadding: 0.2,
                  maxPadding: 0.2,
                  title: {
                      text: 'Value',
                      margin: 80
                  }
              },
              series: []
          });
      });

  </script>

  <script src="https://code.highcharts.com/stock/highstock.js"></script>
  <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>

</head>
<body onload="init();"><!--Start the javascript ball rolling and connect to the mqtt broker-->


<div id="container" style="height: 500px; min-width: 500px"></div><!-- this the placeholder for the chart-->

</body>
</html>
